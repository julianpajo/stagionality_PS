version: "3.5"

services:

    # _____ _   _ _____ 
    #|  __ \ | | |_   _|
    #| |  \/ | | | | |  
    #| | __| | | | | |  
    #| |_\ \ |_| |_| |_ 
    # \____/\___/ \___/ 

    # GUI Section

    gui:
        image: ${BASE_IMAGE_LOCATION}/${PROJECT_NAME}-gui:${BACKEND_VERSION}
        networks:
            - traefik-public
            - euler-dev

    geoserver:
        image: kartoza/geoserver
        deploy:
            labels:
                traefik.enable: "true"
                traefik.http.routers.geoserver-http.entrypoints: https
                traefik.http.routers.geoserver-http.rule: Host(`geoserver.euler.local`)
                traefik.http.routers.geoserver-http.tls: "true"
                traefik.http.routers.geoserver-http.tls.certresolver: georesolver
                traefik.http.services.geoserver.loadbalancer.server.port: "8080"
        environment:
            GEOSERVER_ADMIN_USER: kartoza
            GEOSERVER_ADMIN_PASSWORD: password
        volumes:
            - ${NFS_SHARED_DOCKERDATA}/geoserver/data:/opt/geoserver/data_dir
        networks:
            - traefik-public
            - euler-dev


    #gui-apigw:
    #    image: ${BASE_IMAGE_LOCATION}/${PROJECT_NAME}-gui_apigw:${BACKEND_VERSION}
    #    volumes:
    #    - ${NFS_SHARED_DOCKERDATA}/gui/apigw/logs/:/logs/:rw
    #    networks:
    #    - traefik-public
    #    - euler-dev
    #    environment:


    #____________ 
    #|  _  \ ___ \
    #| | | | |_/ /
    #| | | | ___ \
    #| |/ /| |_/ /
    #|___/ \____/ 

    # Database Section

    db-ps:
        image: ${BASE_IMAGE_LOCATION}/${PROJECT_NAME}-db:${BACKEND_VERSION}
        ports:
            - 5432:5432
        environment:
            PGDATA: /var/lib/postgresql/data/pgdata
            POSTGRES_SERVER: euler
            POSTGRES_DB: EULER
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD_FILE: /run/secrets/postgres_passwd
            DB_HOSTNAME: cots-db
            DB_PORT: 5432
            DB_DATABASE: euler
            DB_USERNAME: euler
            DB_PASSWORD_FILE: /run/secrets/postgres_passwd
            PROJECT_PASSWORD_FILE: /run/secrets/postgres_passwd
            PROJECT_USER: euler
        volumes:
            - ${NFS_SHARED_DOCKERDATA}/postgres/db:/var/lib/postgresql/data:rw
        secrets:
            - postgres_passwd
        networks:
            - euler-dev


    #pgbackup:
    #    image: ${BASE_IMAGE_LOCATION}/${PROJECT_NAME}-pg_backup:${BACKEND_VERSION}
    #    volumes:
    #        - ${NFS_SHARED_BACKUP}/db_ps/:/backups
    #    environment:
    #        POSTGRES_HOST: db-ps
    #        POSTGRES_DBS: euler
    #        POSTGRES_USER: euler
    #        POSTGRES_PORT: 5432
    #        POSTGRES_EXTRA_OPTS: -Z6
    #        BACKUP_DIR: /backups
    #        BACKUP_SUFFIX: .sql
    #        BACKUP_KEEP_DAYS: 7
    #        BACKUP_KEEP_WEEKS: 4
    #        BACKUP_KEEP_MONTHS: 6
    #        BACKUP_KEEP_MINS: 1440
    #        POSTGRES_PASSWORD_FILE: /run/secrets/postgres_passwd
    #    networks:
    #        euler-dev: {}
    #    secrets:
    #        - source: postgres_passwd

networks:
    euler-dev:
        external: true
    traefik-public:
        external: true
secrets:
    postgres_passwd:
       external: true
       name: postgres_passwd
